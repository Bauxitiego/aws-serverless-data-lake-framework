AWSTemplateFormatVersion: "2010-09-09"
Description: Main pipeline

Parameters:
    pPipelineReference:
        Type: String
        Default: none

Resources:
    rMainA:
        Type: awslabs::sdlf::stageA::MODULE
        Properties:
            pPipelineReference: !Ref pPipelineReference
            pStageName: A
            pPipeline: mainG
            pTeamName: iot
            pTriggerType: event
            pEventPattern: >-
                {
                    "source": ["aws.s3"],
                    "detail-type": ["Object Created"],
                    "detail": {
                        "bucket": {
                            "name": ["{{resolve:ssm:/SDLF/S3/CentralBucket}}"]
                        },
                        "object": {
                            "key": [{ "prefix": "iot/legislatorsG/" }]
                        }
                    }
                }
            pEnableTracing: false

    rMainB:
        Type: awslabs::sdlf::stageB::MODULE
        Properties:
            pPipelineReference: !Ref pPipelineReference
            pDatasetBucket: "{{resolve:ssm:/SDLF/S3/StageBucket}}"
            pStageName: B
            pPipeline: mainG
            pTeamName: iot
            pTriggerType: schedule
            pEventPattern: !Sub >-
                {
                    "source": ["aws.states"],
                    "detail-type": ["Step Functions Execution Status Change"],
                    "detail": {
                        "status": ["SUCCEEDED"],
                        "stateMachineArn": ["arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:sdlf-iot-mainG-sm-a"]
                    }
                }
            pSchedule: "cron(*/5 * * * ? *)"
            pEnableTracing: false

    rMainDq:
        Type: proserve::iot::dataquality::MODULE
        Properties:
            pPipelineReference: !Ref pPipelineReference
            pStageName: DQ
            pPipeline: mainG
            pTeamName: iot
            pTriggerType: event
            pEventPattern: !Sub >-
                {
                    "source": ["aws.states"],
                    "detail-type": ["Step Functions Execution Status Change"],
                    "detail": {
                        "status": ["SUCCEEDED"],
                        "stateMachineArn": ["arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:sdlf-iot-mainG-sm-b"]
                    }
                }
            pEnableTracing: false
